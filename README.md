Bike Lights Control
===============

Bike Lights Control is a [widget](https://developer.garmin.com/connect-iq/connect-iq-basics/app-types/#widgets) IQ Connect application for Garmin devices, that allows to manually control ANT+ lights.

| Light Panel | Lights Menu | Light Menu |
| :---------: | :---------: | :--------: |
| <img src="/Images/LightsPanel.png?raw=true"> | <img src="/Images/LightsMenu.png?raw=true"> | <img src="/Images/LightMenu.png?raw=true"> |

## Features
- Configurable full screen light panel for fast switching modes (only for Edge devices with a touch screen)
- Switching modes by using a menu (only for devices without a touch screen)
- Has an alternative light network implementation that can be used for lights with partial ANT+ support
- Support multiple light configurations
- Support controlling multiple headlights/taillights at once

## How to use

1. Download the widget from Garmin Connect Store and synchronize your Garmin device
2. Pair your bike lights with your Garmin device ([Garmin manual](https://www8.garmin.com/manuals/webhelp/variaut/EN-US/GUID-C4BB544A-78FA-4B3E-9061-2371B7B3C558.html))
3. Configure your paired lights with the [Lights Configurator](https://maca88.github.io/BikeLightsControl/) (In case your light is not on the list, check [this thread](https://forums.garmin.com/developer/connect-iq/f/showcase/248492/data-field-smart-bike-lights))
4. Copy the final configuration value from [Lights Configurator](https://maca88.github.io/BikeLightsControl/) into the application setting: `Lights Configuration` by using Garmin Connect Mobile or Garmin Express

## Control modes

| Name | Description |
| :--- | :---------- |
| Network (**N**) | Light is controlled by the Garmin [Light mode](https://www8.garmin.com/manuals/webhelp/variabikelights/EN-US/GUID-73B08487-BA57-4EF0-A253-D226E229BC68.html) |
| Manual (**M**) | Light is controlled by the user |

**NOTE:** As the widget is stateless, the control mode will not be preserved on reopening and Network control mode will be assumed to be the current one.

## Settings

- **Button color:** The color of the light panel buttons
- **Lights Configuration:** The configuration value generated by the [Lights Configurator](https://maca88.github.io/BikeLightsControl/). There are two additional configuration inputs, where the current active is determined by **Current configuration** setting
- **Background Color:** The background color
- **Invert lights:** Whether lights icons and their positions should be inverted
- **Current configuration:** Used to select which `Lights Configuration` to use

## Currently registered ANT+ lights:

- Bontrager Ion Pro RT
- Bontrager Ion 200 RT
- Bontrager Ion 800 RT
- Bontrager Flare RT
- Garmin Varia TL300
- Garmin Varia RTL500
- Garmin Varia RTL501
- Garmin Varia RTL510
- Garmin Varia RTL511
- Garmin Varia RTL515
- Garmin Varia RTL516
- Garmin Varia RCT715
- Garmin Varia HL500
- Garmin Varia UT800
- Giant Recon HL1800
- Cycliq Fly12 CE (supported only by using Individual Light Network)
- Cycliq Fly6 CE (supported only by using Individual Light Network)
- See.Sense ACE Front/Rear (supported only by using Individual Light Network)
- See.Sense BEAM/BEAM+ (supported only by using Individual Light Network)
- See.Sense ICON2 (supported only by using Individual Light Network)

**NOTE:** In case your ANT+ light is not on the list, please check the following garmin thread: https://forums.garmin.com/developer/connect-iq/f/showcase/248492/data-field-smart-bike-lights

## Individual Light Network

Individal Light Network is an alternative light network implementation for connecting and controlling ANT+ lights. In comparison to the Garmin built-in light network, 
this network does not form a light network when two lights are connected, but instead it establish a separate connection for every light. This mode needs 
to be used for lights that have issues with the built-in light network (See Sense and Cycliq lights).

**NOTE:** Lights in Garmin Sensors menu need to be disabled or removed in order to use this feature!

Known limitations:
- It requires to manually set the device numbers for the lights
- It will not turn off the lights when the device goes to sleep
- It uses one ANT channel per light

## Control multiple lights of the same type

There are two ways to control more than one light of the same type (e.g. two headlights):

### Grouping them into one virtual light

In case there is more than one taillight or headlight paired, the data field will automatically group all headlights or taillights into one virtual light, which will forward commands (e.g. light mode changes) to all grouped lights. For the battery level, it will display the lowest battery level of the grouped lights. When pairing different headlights or taillights (e.g. Varia 515 and Flare RT), the virtual light will display only light modes that both lights support, based on the light mode number. For example when grouping Varia 515 and Flare RT, the following light modes will be available:
```
0 - Off
5 - Peloton for Varia 515 and Night Steady for Flare RT
7 - Day Flash
```
even if they both supports "Night Flash" mode, it will not be displayed, because Flare RT uses 63 and Varia 6 for the light mode number.

### Installing [Bike Lights Control #2](https://apps.garmin.com/en-US/apps/910e3f6c-24ba-4d11-94b7-96e12ee4d568) widget

`Bike Lights Control #2` widget is a copy of the original widget, which can be used along with the original one and configured separately. By using both widgets, it is possible to configure two lights of the same type (e.g. two headlights), one configured in the original widget and the other in the copy widget. When creating the configuration for the lights, it is required to set the `Serial number` input in [Lights Configurator](https://maca88.github.io/BikeLightsControl/), so that the data field will know which of the two lights to control.

## Error codes

The following errors can be displayed:
- **Error 1:** A not supported light type is connected, only headlights and taillights are supported.
- **Error 2:** Two or more lights of the same type are connected to the network, which is not supported.
- **Error 3:** Light panel contains a light mode that the connected light does not support.
- **Error 4:** Configuration value is invalid.
- **Error 5:** The device does not have enough free ANT channels to be used by the Individual Light Network. Try to disable some sensors from the Garmin Sensors menu.
- **Error 6:** One of the ANT channels used by the Individual Light Network could not be opened. Make sure that the lights are removed/disabled from the Garmin Sensors menu.
- **Error 7:** The light with the provided device number does not support the configured light type (headlight/taillight). Make sure that the "Device number" setting on the configured light is not of another light.
